namespace = ex_spawn_engine_3

event = { #game start event only. Note: the event name is tuned respective of other mods that load in the same array.
	id = ex_spawn_engine_3.0
	hide_window = yes
	fire_only_once = yes
	
	immediate = { 
		set_global_flag = guillis_planet_modifiers_active
		every_planet = { 
			if = { #this adds a unique flag to gas giant moons, which is checked through a scripted trigger (see common/scripted_triggers/ex_engine_triggers.txt )
				limit = {
					is_planet_class = pc_gas_giant
					has_moon = yes
					any_moon = { NOT = { has_planet_flag = gas_giant_moon } }
				}
				every_moon = { set_planet_flag = gas_giant_moon }
			}				
			if = {
				limit = { #i'll add conditions for STNH and some other stuff later.
					NAND = { 
						has_owner = yes
						owner = { is_country_type = default }
						is_capital = yes
					}
				}		
				planet_event = { id = ex_spawn_engine_3.1 } #we need to fire secondary events since we have fire_only_once toggled
			}	
		}
	}
}

planet_event = { 
	id = ex_spawn_engine_3.1
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		remove_regular_planet_modifiers = yes		
		#this variable stores the number of vanilla special modifiers (not removed) and modifiers from other mods - if present.	 
		set_variable = { which = other_pm_points value = 0 } 
		#this variable stores the number of planet modifiers that will be rolled on the planet. 
		set_variable = { which = pm_points value = 0 } 
		#these variables are used to determine modifier distribution
		set_variable = { which = positive_pm_points value = 0 }
		set_variable = { which = neutal_pm_points value = 0 }
		set_variable = { which = mixed_pm_points value = 0 }
		set_variable = { which = negative_pm_points value = 0 }
		if = { #if after the removal some modifiers are still present, these either come from other mods or are special vanilla modifiers. We will record their numbers in variable = other_pm_points.
			limit = { num_modifiers > 0 } 			
			check_other_modifiers = yes #first step - store the number of non-vanilla modifiers in the "other_pm_points"
		}						
		roll_pm_points = yes #second step - roll "pm_points" for each planet
		subtract_variable = { which = pm_points value = other_pm_points } #third step - subtracts other_pm_points from pm_points
		if = { 
			limit = { check_variable = { which = pm_points value > 0 } }			
			calculate_pm_points = yes #fourth step - divides pm_points into positive/neutral/mixed/negative_pm_points
			else = { break = yes } #if the number of pm_points is 0 or lower, terminate at this juncture - no new planet modifiers will spawn, otherwise continue.
		}		
	}
}	

country_event = { #this is a contingency - in case the mod is not loaded in gamestart, but is nonetheless present. 
	id = ex_spawn_engine_2.2
	hide_window = yes
	fire_only_once = yes
	
	trigger = { NOT = { has_global_flag = guillis_planet_modifiers_active } }
	
	immediate = { set_global_flag = guillis_planet_modifiers_active }
}
