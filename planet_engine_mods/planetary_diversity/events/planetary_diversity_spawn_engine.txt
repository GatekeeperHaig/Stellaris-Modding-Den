###### Written by ExNihil
#
#	This mod uses a configurable spawn engine. If you'd like to integrate a version of this engine please join our discord server The Stellaris Modding Den
#	Server invite: https://discord.gg/ZhvBXhh

namespace = spawn_engine_1

event = {
	#this event triggers on game start
	id = spawn_engine_1.0
	hide_window = yes
	is_triggered_only = yes
	
	trigger = { 
		NOT = { has_global_flag = planetary_diversity_active } #this ensures the global flag will be set up correctly on mod loadup - if load into savegame is enabled. 		
	} 
	
	immediate = {
		set_global_flag = planetary_diversity_active #this sets a global flag for this mod, to be used by other mods and the engine		
		every_planet = { 
			limit = { planetary_diversity_special_planet = yes }
			planetary_diversity_unique_planet_init = yes
		}	
		#the effect below is the firing effect of the spawn engine - 
		#look in pd_engine_effects.txt 
		#this effect is fired from CGM if the PD planets only setting is chosen. 
		if = { 
			limit = { NOT = { has_global_flag = planets_enhanced_game_start_flag } }			
			planetary_diversity_regular_planet_init = yes
		}
	}
}	
planet_event = {
	id = spawn_engine_1.1
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		if = {
			limit = { is_vanilla_habitable_planet = yes }			
			planetary_diversity_habitable_planets_spawn_table = yes
			if = {
				limit = { 
					exists = owner
					owner = { is_country_type = primitive } 
					is_ideal_planet_class = { who = owner status = no }
				}			
				change_owner_species_to_this_planet_preference = yes							
			}
			#please adjust the odds on the effects below to change the general ratio of tile blockers and deposits on regular planets
			every_tile = {
				limit = { has_blocker = no has_building = no has_pop = no }
				random_list = {
					30 = { planetary_diversity_tile_blocker_spawn_table = yes }
					70 = { }
				}					
			}
			every_tile = {
				limit = { has_deposit = no }
				random_list = {
					50 = { planetary_diversity_planetary_resource_spawn_table = yes }
					50 = { }
				}					
			}			
		}	
		else_if = {
			limit = { is_vanilla_uninhabitable_planet = yes }
			planetary_diversity_uninhabitable_planets_spawn_table = yes
		}
		if = {
			limit = { 
				OR = { 
					is_vanilla_habitable_planet = yes
					planetary_diversity_regular_habitable_planet = yes #this trigger does no include the planetary_diversity_special_planet trigger and its planets.
				}	
				has_regular_vanilla_planet_modifier = yes
				NOT = { has_global_flag = gpm_vanilla_spawn_engine_enabled }
			}
			remove_and_count_vanilla_regular_planet_modifiers = yes
			while = {
				limit = {
					check_variable = { which = "pm_points" value > 0 }
				}
				planet_modifier_spawn_table = yes
				change_variable = { which = "pm_points" value = -1 }
			}
			if = { 
				limit = {
					NAND = { 
						any_tile = { has_deposit = yes } 	
						any_tile = { has_blocker = yes } 
					}	
					deposit_and_blocker_threshold_limit = yes					
				}	
				spawn_deposits_and_blockers = yes				
			}	
		}			
	}
}
country_event = {
	id = spawn_engine_1.2
	hide_window = yes
	is_triggered_only = yes
	trigger = { 
		has_country_flag = pd_game_host
		NOT = { has_global_flag = planets_enhanced_game_start_flag }
	}
	immediate = {
		every_planet = { 
			limit = { 
				habitable_planet = yes
				OR = { 
					NOT = { any_tile = { has_deposit = yes } }
					NOT = { any_tile = { has_blocker = yes } }
					deposit_and_blocker_threshold_limit = yes							
				}					
			}				
			spawn_deposits_and_blockers = yes	
		}	
	}	
}	
country_event = { 
	id = spawn_engine_1.4
	hide_window = yes
	is_triggered_only = yes
	
	trigger = { 
		is_ai = no 
		NOT = { has_global_flag = pd_game_host_set } 
	}
	immediate = { 
		set_country_flag = pd_game_host 
		set_timed_global_flag = { flag = pd_game_host_set days = 1 } 
	}
}	
	
country_event = {
	#this event is triggered by the first event
	id = spawn_engine_1.3
	hide_window = yes
	is_triggered_only = yes
	
	trigger = { 
		OR = { 
			AND = { 
				NOT = { has_global_flag = planets_enhanced_game_start_flag }
				has_country_flag = pd_game_host
			}	
			has_country_flag = cgm_game_host
		}	
	}

	immediate = { 
		every_country = { 
			limit = { is_country_type = default }
			capital_scope = { 
				every_planet = { 		
					limit = { 							
						NOT = { is_same_value = prev } 
						habitable_planet = yes
						has_planet_flag = prescripted_ideal					
						distance = { 
							source = prev
							min_distance >= 1
							max_distance <= 55
						}					
					}
					if = { 
						limit = { is_ideal_planet_class = { who = prevprev status = no } }
						if = { limit = { prev = { is_planet_class = pc_tropical } } change_pc = pc_tropical }
						else_if = { limit = { prev = { is_planet_class = pc_arid } } change_pc = pc_arid }
						else_if = { limit = { prev = { is_planet_class = pc_continental } } change_pc = pc_continental }
						else_if = { limit = { prev = { is_planet_class = pc_ocean } } change_pc = pc_ocean }
						else_if = { limit = { prev = { is_planet_class = pc_tundra } } change_pc = pc_tundra }
						else_if = { limit = { prev = { is_planet_class = pc_arctic } } change_pc = pc_arctic }
						else_if = { limit = { prev = { is_planet_class = pc_alpine } } change_pc = pc_alpine }
						else_if = { limit = { prev = { is_planet_class = pc_savannah } } change_pc = pc_savannah }
						else_if = { limit = { prev = { is_planet_class = pc_tidallylocked } } change_pc = pc_tidallylocked }
						else_if = { limit = { prev = { is_planet_class = pc_mangrove } } change_pc = pc_mangrove }
						else_if = { limit = { prev = { is_planet_class = pc_desertislands } } change_pc = pc_desertislands }
						else_if = { limit = { prev = { is_planet_class = pc_hajungle } } change_pc = pc_hajungle }
						else_if = { limit = { prev = { is_planet_class = pc_cascadian } } change_pc = pc_cascadian }
						else_if = { limit = { prev = { is_planet_class = pc_swamp } } change_pc = pc_swamp }
						else_if = { limit = { prev = { is_planet_class = pc_subarctic } } change_pc = pc_subarctic }
						else_if = { limit = { prev = { is_planet_class = pc_glacial } } change_pc = pc_glacial }
						else_if = { limit = { prev = { is_planet_class = pc_geothermal } } change_pc = pc_geothermal }
						else_if = { limit = { prev = { is_planet_class = pc_sandsea } } change_pc = pc_sandsea }
						else_if = { limit = { prev = { is_planet_class = pc_mesa } } change_pc = pc_mesa }
						else_if = { limit = { prev = { is_planet_class = pc_oasis } } change_pc = pc_oasis }
						else_if = { limit = { prev = { is_planet_class = pc_hadesert } } change_pc = pc_hadesert }
						else_if = { limit = { prev = { is_planet_class = pc_steppe } } change_pc = pc_steppe }
						else_if = { limit = { prev = { is_planet_class = pc_frozen_desert } } change_pc = pc_frozen_desert }
						else_if = { limit = { prev = { is_planet_class = pc_antarctic } } change_pc = pc_antarctic }
						else_if = { limit = { prev = { is_planet_class = pc_ammonia } } change_pc = pc_ammonia }
						else_if = { limit = { prev = { is_planet_class = pc_methane } } change_pc = pc_methane }				
						spawn_deposits_and_blockers = yes
					}
				}
			}	
		}
	}
}

country_event = { 
	id = spawn_engine_1.5
	hide_window = yes
	is_triggered_only = yes
	
	trigger = {
		is_country_type = default
	}	
	
	immediate = {
		capital_scope = {
			every_tile = {
				limit = {
					has_deposit = no									
				}
				random_list = {
					65 = { planetary_diversity_planetary_resource_spawn_table = yes }
					35 = { }
				}
			}
		}
	}
}	