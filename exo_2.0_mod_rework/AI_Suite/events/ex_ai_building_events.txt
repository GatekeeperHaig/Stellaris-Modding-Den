namespace = ex_ai_building_events

event = { #this event sets variables into scopes. It fires on a monthly pulse and on game start. 
	id = ex_ai_building_events.0
	hide_window = yes
	is_triggered_only = yes
		
	immediate = {
		every_country = {
			limit = { 
				OR = {
					is_country_type = default
					is_country_type = fallen_empire
					is_country_type = awakened_fallen_empire
				}	
			}	
			country_event = { id = ex_ai_building_events.1 days = 1 }
			if = { 
				limit = { NOT = { has_country_flag = ex_ai_variables_added_country } }				
				set_variable = { which = energy_mult value = 0 }
				set_variable = { which = minerals_mult value = 0 }
				set_variable = { which = food_mult value = 0 }	
				set_country_flag = ex_ai_variables_added_country
			}	
			every_owned_planet = {
				limit = { 
					is_colony = yes
					OR = {
						owner = { is_ai = yes }
						sector_controlled = yes
					}	
				}
				every_owned_pop = {
					if = { 
						limit = { NOT = { has_pop_flag = ex_ai_variables_added_pop } }					
						set_variable = { which = energy_mult value = 0 }
						set_variable = { which = minerals_mult value = 0 }
						set_variable = { which = food_mult value = 0 }
						set_variable = { which = unity_mult value = 0 }
						set_variable = { which = society_research_mult value = 0 }
						set_variable = { which = physics_research_mult value = 0 }
						set_variable = { which = engineering_research_mult value = 0 }
						set_pop_flag = ex_ai_variables_added_pop				
					}		
				}	
				if = { 
					limit = { NOT = { has_planet_flag = ex_ai_variables_added_planet } }					
					set_variable = { which = energy_mult value = 0 }
					set_variable = { which = minerals_mult value = 0 }
					set_variable = { which = food_mult value = 0 }
					set_variable = { which = unity_mult value = 0 }
					set_variable = { which = society_research_mult value = 0 }
					set_variable = { which = physics_research_mult value = 0 }
					set_variable = { which = engineering_research_mult value = 0 }
					every_tile = {
						limit = { is_orbital_tile = no }
						#multiplier variables
						set_variable = { which = energy_mult value = 1 }
						set_variable = { which = minerals_mult value = 1 }
						set_variable = { which = food_mult value = 1 }
						set_variable = { which = unity_mult value = 1 }
						set_variable = { which = society_research_mult value = 1 }
						set_variable = { which = physics_research_mult value = 1 }
						set_variable = { which = engineering_research_mult value = 1 }					
						#deposit/adj. variables
						set_variable = { which = energy_weight value = 0 }
						set_variable = { which = minerals_weight value = 0 }
						set_variable = { which = food_weight value = 0 }
						set_variable = { which = unity_weight value = 0 }
						set_variable = { which = society_research_weight value = 0 }
						set_variable = { which = physics_research_weight value = 0 }
						set_variable = { which = engineering_research_weight value = 0 }
						#building weight variables
						set_variable = { which = energy_building_tile value = 0 }
						set_variable = { which = minerals_building_tile value = 0 }
						set_variable = { which = food_building_tile value = 0 }
						set_variable = { which = society_research_building_tile value = 0 }
						set_variable = { which = physics_research_building_tile value = 0 }
						set_variable = { which = engineering_research_building_tile value = 0 }
						#building adj. weight variables
						set_variable = { which = energy_building_adj_weight value = 0 }
						set_variable = { which = minerals_building_adj_weight value = 0 }
						set_variable = { which = food_building_adj_weight value = 0 }
						set_variable = { which = society_research_building_adj_weight value = 0 }
						set_variable = { which = physics_research_building_adj_weight value = 0 }
						set_variable = { which = engineering_research_building_adj_weight value = 0 }															
					}
					set_planet_flag = ex_ai_variables_added_planet
				}	
			}			
		}
	}
}	

country_event = { #this event runs on a monthly scope. 
	id = ex_ai_building_events.1
	hide_window = yes
	is_triggered_only = yes

	immediate = { 
		check_deficities = yes
		check_income_level = yes
		every_owned_planet = {
			limit = { 
				is_colony = yes
				OR = {
					owner = { is_ai = yes }
					sector_controlled = yes
				}	
			}
			if = { 
				limit = { 
					OR = {
						has_bonus_planet_modifier = yes
						has_planet_bonus_building = yes
						AND = {
							has_global_flag = ex_planets_enhanced_active
							has_planets_enhanced_planet_bonus_buildings = yes									
						}	
					}
				}
				calculate_planet_weights = yes
			}	
			every_owned_pop = {
				limit = { OR = { is_robot_pop = yes is_sapient = yes } }
				calculate_pop_multipliers = yes
			}				
			every_tile = {
				limit = { 
					is_orbital_tile = no
					has_blocker = no
				}
				if = {
					limit = { 
						any_neighboring_tile = { 
							OR = {
								AND = {
									has_building = yes
									OR = { 	
										has_capital_building = yes
										has_hyperstorage_building = yes 
										has_polytechnic_building = yes
										has_special_capital_resource_building = yes
										AND = {
											has_global_flag = ex_planets_enhanced_active
											has_sr_adj_bonus_building = yes
										}	
									}	
								}
								AND = {
									has_blocker = yes
									has_adj_bonus_blocker = yes
								}		
							}							
						}							
					}
					calculate_adjcancy_weights = yes
				}
				calculate_tile_weights = yes
				calculate_adj_potential_weights = yes
			}					
		}		
	}	
}

#this event runs on a monthly scope.
#it places planet flags that are used by specific planet unique buildings

event = {  
	id = ex_ai_building_events.2
	hide_window = yes
	is_triggered_only = yes
	
	immediate = {
		every_country = {
			limit = { is_country_type = default	}	
			every_owned_planet = {
				if = { #military buildings
					limit = { 
						years_passed > 25
						NOR = { 
							has_planet_flag = fortify_planet
							AND = {
								prev = { is_at_war = no }
								count_tile = {
									limit = {
										OR = {
											has_building = building_stronghold
											has_building = building_fortress
										}
									}
									count > 2
								}	
							}	
						}
						OR = {
							unrest > 50
							any_country = {
								is_at_war_with = prevprev
								any_owned_planet = {
									is_colony = yes
									distance = { source = prevprev min = 70 max = 100 }
								}
							}	
									
							AND = {
								OR = {
									has_capital_1 = yes
									has_capital_2 = yes
								}	
								NOR = {
									has_building = building_stronghold
									has_building = building_fortress	
								}
							}	
							AND = {
								has_capital_3 = yes
								count_tile = {
									limit = {
										OR = {
											has_building = building_stronghold
											has_building = building_fortress
										}
									}
									count < 2
								}	
							}								
						}
					}
					set_timed_planet_flag = { flag = fortify_planet days = 30 }
				}
				if = { #pop growth buildings
					limit = { 
						prev = {
							OR = { 
								has_technology = "tech_frontier_health"
								has_technology = "tech_frontier_hospital"
							}
						}
						NOR = { 
							has_building = building_clinic
							has_building = building_building_hospital							
							has_building = building_spare_parts_depot
							has_building = building_unit_assembly_plant							
						}	
						free_pop_tiles > 2
						OR = {
							any_owned_pop = {
								is_robot_pop = no								
								has_population_control = no
							}								
							AND = {
								prev = { 
									OR = {
										has_authority = auth_machine_intellgience
										has_country_flag = synthethic_age
									}
									balance > 250
								}	
								any_owned_pop = { is_robot_pop = yes }
							}
						}
					}
					set_timed_planet_flag = { flag = build_pop_growth_building days = 30 }
				}
				if = {
					limit = {
						prev = { 
							has_technology = "tech_neural_implants"
							OR = {
								AND = {
									overhauled_building_content_enabled = no
									is_machine_empire = no
								}	
								AND = {
									overhauled_building_content_enabled = yes
									is_gestalt_consciousness = no
								}	
							}
							has_policy_flag = slavery_allowed
						}
						any_owned_pop = { is_enslaved = yes }
						OR = {
							count_pops = {
								limit = { 
									OR = {
										has_slavery_type = { country = owner type = slavery_military }
										has_slavery_type = { country = owner type = slavery_normal }
									}	
								}
								count > 2
							}	
							unrest > 30
						}	
					}	
					set_timed_planet_flag = { flag = build_slave_processing days = 30 }
				}								
			}					
		}
	}
}	