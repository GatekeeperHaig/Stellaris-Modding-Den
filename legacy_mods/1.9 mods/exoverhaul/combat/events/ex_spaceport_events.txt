namespace = ex_spaceport_events

event = { #this event fires on game start 
	id = ex_spaceport_events.0
	hide_window = yes
	is_triggered_only = yes

	immediate = { 
		every_country = { 
			limit = {
				OR = {
					is_country_type = default
					is_country_type = fallen_empire
					is_country_type = awakened_fallen_empire
				}
			}	
			every_owned_planet = { 				
				limit = { has_spaceport = yes }				
				planet_event = { id = ex_spaceport_events.10 }														
			}	
		}
	}	
}

ship_event = { #this event fires the moment a spaceport is built
	id = ex_spaceport_events.1
	hide_window = yes
	is_triggered_only = yes

	immediate = { 
		from = { 
			remove_spaceport_flags_and_modifiers = yes	
			remove_construction_active = yes
			update_shield_modifiers = yes 
			update_spaceport_weapon_modifiers = yes			
			planet_event = { id = ex_spaceport_events.10 }							
		}			
	}
} 		


country_event = { #this event fires whenever a new technology is researched
	id = ex_spaceport_events.2
	hide_window = yes
	is_triggered_only = yes
	
	immediate = {
		if = { limit = { last_increased_tech = tech_psionic_shield } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }
		if = { limit = { last_increased_tech = tech_shields_5 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }
		if = { limit = { last_increased_tech = tech_shields_4 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }
		if = { limit = { last_increased_tech = tech_shields_3 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }
		if = { limit = { last_increased_tech = tech_shields_2 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }	
		if = { limit = { last_increased_tech = tech_shields_1 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }	
		if = { limit = { last_increased_tech = tech_lasers_5 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }
		if = { limit = { last_increased_tech = tech_lasers_4 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }
		if = { limit = { last_increased_tech = tech_lasers_3 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }
		if = { limit = { last_increased_tech = tech_lasers_2 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }	
		if = { limit = { last_increased_tech = tech_mass_drivers_5 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }
		if = { limit = { last_increased_tech = tech_mass_drivers_4 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }
		if = { limit = { last_increased_tech = tech_mass_drivers_3 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }
		if = { limit = { last_increased_tech = tech_mass_drivers_2 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }		
		if = { limit = { last_increased_tech = tech_missiles_5 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }
		if = { limit = { last_increased_tech = tech_missiles_4 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }
		if = { limit = { last_increased_tech = tech_missiles_3 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }
		if = { limit = { last_increased_tech = tech_missiles_2 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }	
		if = { limit = { last_increased_tech = tech_kinetic_artillery_3 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }	
		if = { limit = { last_increased_tech = tech_kinetic_artillery_2 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }		
		if = { limit = { last_increased_tech = tech_flak_batteries_3 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }
		if = { limit = { last_increased_tech = tech_flak_batteries_2 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }	
		if = { limit = { last_increased_tech = tech_swarmer_missiles_3 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }
		if = { limit = { last_increased_tech = tech_swarmer_missiles_2 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }	
		if = { limit = { last_increased_tech = tech_energy_torpedoes_3 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }
		if = { limit = { last_increased_tech = tech_energy_torpedoes_2 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }
		if = { limit = { last_increased_tech = tech_autocannons_3 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }
		if = { limit = { last_increased_tech = tech_autocannons_2 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }	
		if = { limit = { last_increased_tech = tech_torpedoes_3 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }
		if = { limit = { last_increased_tech = tech_torpedoes_2 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }		
		if = { limit = { last_increased_tech = tech_strike_craft_3 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }
		if = { limit = { last_increased_tech = tech_strike_craft_2 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }	
		if = { limit = { last_increased_tech = tech_plasma_3 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }
		if = { limit = { last_increased_tech = tech_plasma_2 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }		
		if = { limit = { last_increased_tech = tech_disruptors_3 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }
		if = { limit = { last_increased_tech = tech_disruptors_2 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }		
		if = { limit = { last_increased_tech = tech_pd_tracking_3 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }
		if = { limit = { last_increased_tech = tech_pd_tracking_2 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }
		if = { limit = { last_increased_tech = tech_energy_lance_2 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }
		if = { limit = { last_increased_tech = tech_energy_lance_3 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }
		if = { limit = { last_increased_tech = tech_mass_accelerator_2 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }
		if = { limit = { last_increased_tech = tech_mass_accelerator_3 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }
		if = { limit = { last_increased_tech = tech_xl_missile_2 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }
		if = { limit = { last_increased_tech = tech_xl_missile_3 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }
		if = { limit = { last_increased_tech = tech_xl_disruptor_2 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }
		if = { limit = { last_increased_tech = tech_xl_disruptor_3 } every_owned_planet = { limit = { has_spaceport = yes } update_shield_modifiers = yes break = yes } }									
	}		
}
	

country_event = { #this event is triggered when a spaceport is destroyed (not dismantled).
	id = ex_spaceport_events.3
	hide_window = yes
	is_triggered_only = yes
	trigger = {	fromfrom = { is_ship_size = orbital_station } }			
    immediate = { 
		fromfrom = { 
			orbit = { 
				planet = { 
					remove_planet_flag = spaceport_automation_economic_specialized	
					remove_planet_flag = spaceport_automation_economic_mixed
					remove_planet_flag = spaceport_automation_stardock_specialized
					remove_planet_flag = spaceport_automation_defensive_specialized
					remove_planet_flag = spaceport_automation_defensive_mixed	
					remove_planet_flag = spaceport_automation_disable_local						
					remove_spaceport_flags_and_modifiers = yes
				}
			}
		}
	}
}
				
country_event = { #this event is triggered when a spaceport is dismantled.
	id = ex_spaceport_events.4
	hide_window = yes
	is_triggered_only = yes
	trigger = { from = { is_ship_size = orbital_station } }	
	immediate = { 
		from = { 
			orbit = { 
				planet = { 		
					if = { 
						limit = { NOT = { has_planet_flag = rebuild_process } }
						remove_planet_flag = spaceport_automation_economic_specialized	
						remove_planet_flag = spaceport_automation_economic_mixed
						remove_planet_flag = spaceport_automation_stardock_specialized
						remove_planet_flag = spaceport_automation_defensive_specialized
						remove_planet_flag = spaceport_automation_defensive_mixed	
						remove_planet_flag = spaceport_automation_disable_local			
						remove_spaceport_flags_and_modifiers = yes
					}	
				}
			}
		}
	}
}	

event = { #this event fires on a monthly pulse
	id = ex_spaceport_events.6
	hide_window = yes
	is_triggered_only = yes

	immediate = { 
		every_country = { 
			limit = {
				OR = {
					is_country_type = default
					is_country_type = fallen_empire
					is_country_type = awakened_fallen_empire
				}
			}	
			every_owned_planet = { 				
				if = { limit = { has_spaceport = no	NOT = { has_planet_flag = spaceport_flags_removed } has_spaceport_level_flag = yes } remove_spaceport_flags_and_modifiers = yes	}
				if = { limit = { has_spaceport = yes } update_shield_modifiers = yes update_spaceport_weapon_modifiers = yes } 
			}
		}
	}
}				

planet_event = { # this event runs on every tick (day), applying a flag
	id = ex_spaceport_events.9
	hide_window = yes
	
	trigger = {
		has_owner = yes
		has_spaceport = yes
		spaceport = { has_free_spaceport_module_slot = yes }
	}

	immediate = { 		
		planet_event = { id = ex_spaceport_events.10 }
		if = { limit = { is_automation_enabled = yes } planet_event = { id = ex_spaceport_events.11 days = 1 } }
	}
}	

planet_event = { # this event runs on every tick (day), checking and adding/removing planet spaceport level flags/modifiers as needed. 
	id = ex_spaceport_events.10
	hide_window = yes
	is_triggered_only = yes
	
	trigger = { 		
		OR = {			
			switch = {
				trigger = is_spaceport_module_slot_free
				9 = { OR = { NOT = { check_variable = { which = "spaceport_level" value > 8 } } } }
				8 = { OR = { NOT = { check_variable = { which = "spaceport_level" value > 7 } } } }
				7 = { OR = { NOT = { check_variable = { which = "spaceport_level" value > 6 } } } }
				6 = { OR = { NOT = { check_variable = { which = "spaceport_level" value > 5 } } } }
				5 = { OR = { NOT = { check_variable = { which = "spaceport_level" value > 4 } } } }
				4 = { OR = { NOT = { check_variable = { which = "spaceport_level" value > 3 } } } }
				3 = { OR = { NOT = { check_variable = { which = "spaceport_level" value > 2 } } } }
				2 = { OR = { NOT = { check_variable = { which = "spaceport_level" value > 1 } } } }
				1 = { OR = { NOT = { check_variable = { which = "spaceport_level" value > 0 } } } }
			}
		}	
	}
	
	immediate = {
		if = { limit = { has_planet_flag = spaceport_flags_removed } remove_planet_flag = spaceport_flags_removed }		
		switch = {
			trigger = is_spaceport_module_slot_free
			9 = { if = { limit = {  NOT = { check_variable = { which = "spaceport_level" value > 8 } } } set_variable = { which = "spaceport_level" value = 9 } update_spaceport_level = yes } }					
			8 = { if = { limit = {  NOT = { check_variable = { which = "spaceport_level" value > 7 } } } set_variable = { which = "spaceport_level" value = 8 } update_spaceport_level = yes } }	
			7 = { if = { limit = {  NOT = { check_variable = { which = "spaceport_level" value > 6 } } } set_variable = { which = "spaceport_level" value = 7 } update_spaceport_level = yes } }	
			6 = { if = { limit = {  NOT = { check_variable = { which = "spaceport_level" value > 5 } } } set_variable = { which = "spaceport_level" value = 6 } update_spaceport_level = yes } }	
			5 = { if = { limit = {  NOT = { check_variable = { which = "spaceport_level" value > 4 } } } set_variable = { which = "spaceport_level" value = 5 } update_spaceport_level = yes } }	
			4 = { if = { limit = {  NOT = { check_variable = { which = "spaceport_level" value > 3 } } } set_variable = { which = "spaceport_level" value = 4 } update_spaceport_level = yes } }	
			3 = { if = { limit = {  NOT = { check_variable = { which = "spaceport_level" value > 2 } } } set_variable = { which = "spaceport_level" value = 3 } update_spaceport_level = yes } }	
			2 = { if = { limit = {  NOT = { check_variable = { which = "spaceport_level" value > 1 } } } set_variable = { which = "spaceport_level" value = 2 } update_spaceport_level = yes } }	
			1 = { if = { limit = {  NOT = { check_variable = { which = "spaceport_level" value > 0 } } } set_variable = { which = "spaceport_level" value = 1 } update_spaceport_level = yes } }	
		}			
	}
}	

planet_event = { # this event runs on every tick (day), checking whether automation is enabled, if it is and there is an empty slot flag + no "module under construction" module on the planet, it fires the automation event.
	id = ex_spaceport_events.11
	hide_window = yes
	is_triggered_only = yes

	trigger = {					
		OR = {
			AND = {
				is_spaceport_module_slot_free = 1
				NOT = { has_spaceport_module = slot_unavailable_1 }
			}	
			AND = {
				is_spaceport_module_slot_free = 2
				NOT = { has_spaceport_module = slot_unavailable_2 }
			}				
			AND = {
				is_spaceport_module_slot_free = 3
				NOT = { has_spaceport_module = slot_unavailable_3 }
			}				
			AND = {
				is_spaceport_module_slot_free = 4
				NOT = { has_spaceport_module = slot_unavailable_4 }
			}				
			AND = {
				is_spaceport_module_slot_free = 5
				NOT = { has_spaceport_module = slot_unavailable_5 }
			}				
			AND = {
				is_spaceport_module_slot_free = 6
				NOT = { has_spaceport_module = slot_unavailable_6 }
			}				
			AND = {
				is_spaceport_module_slot_free = 7
				NOT = { has_spaceport_module = slot_unavailable_7 }
			}				
			AND = {
				is_spaceport_module_slot_free = 8
				NOT = { has_spaceport_module = slot_unavailable_8 }
			}				
			AND = {
				is_spaceport_module_slot_free = 9
				NOT = { has_spaceport_module = slot_unavailable_9 }
			}							
		}				
	}	
	
	immediate = { 
		#set_timed_planet_flag = { flag = flag_delay_2 days = 1 } #this is meant to gate the following event		
		if = { 
			limit = { is_spaceport_module_slot_free = 1 NOR = { has_planet_flag = module_under_construction_slot_1 has_spaceport_module = slot_unavailable_1 } }
			set_spaceport_module = { slot = 1 module = "slot_unavailable_1" }			
		}	
		if = {
			limit = { is_spaceport_module_slot_free = 2 NOR = { has_planet_flag = module_under_construction_slot_2 has_spaceport_module = slot_unavailable_2 } }
			set_spaceport_module = { slot = 2 module = "slot_unavailable_2" }			
		}	
		if = {
			limit = { is_spaceport_module_slot_free = 3 NOR = { has_planet_flag = module_under_construction_slot_3 has_spaceport_module = slot_unavailable_3 } }
			set_spaceport_module = { slot = 3 module = "slot_unavailable_3" }			
		}	
		if = {
			limit = { is_spaceport_module_slot_free = 4 NOR = { has_planet_flag = module_under_construction_slot_4 has_spaceport_module = slot_unavailable_4 } }
			set_spaceport_module = { slot = 4 module = "slot_unavailable_4" }			
		}
		if = {
			limit = { is_spaceport_module_slot_free = 5 NOR = { has_planet_flag = module_under_construction_slot_5 has_spaceport_module = slot_unavailable_5 } }
			set_spaceport_module = { slot = 5 module = "slot_unavailable_5" }			
		}
		if = {
			limit = { is_spaceport_module_slot_free = 6 NOR = { has_planet_flag = module_under_construction_slot_6 has_spaceport_module = slot_unavailable_6 } }
			set_spaceport_module = { slot = 6 module = "slot_unavailable_6" }			
		}	
		if = {
			limit = { is_spaceport_module_slot_free = 7 NOR = { has_planet_flag = module_under_construction_slot_7 has_spaceport_module = slot_unavailable_7 } }
			set_spaceport_module = { slot = 7 module = "slot_unavailable_7" }			
		}	
		if = {
			limit = { is_spaceport_module_slot_free = 8 NOR = { has_planet_flag = module_under_construction_slot_8 has_spaceport_module = slot_unavailable_8 } }
			set_spaceport_module = { slot = 8 module = "slot_unavailable_8" }			
		}	
		if = {
			limit = { is_spaceport_module_slot_free = 9 NOR = { has_planet_flag = module_under_construction_slot_9 has_spaceport_module = slot_unavailable_9 } }
			set_spaceport_module = { slot = 9 module = "slot_unavailable_9" }			
		}							
	}
}	
	
#the events below are spaceport development automation events.

planet_event = { #this event checks the spaceport type, compares to the edict and replaces the spaceport itself as needed. 
	id = ex_spaceport_events.100
	hide_window = yes
	#is_triggered_only = yes

	trigger = {			
		has_owner = yes
		has_spaceport = yes		
		has_spaceport_construction = no
		is_automation_enabled = yes
		module_construction_active = no
		has_slot_unavailable_module = yes		
		if = {
			limit = { owner = { has_policy_flag = minimum_250_for_module_auto_construction } }
			owner = { minerals > 500 }
		}	
		if = {
			limit = { owner = { has_policy_flag = minimum_500_for_module_auto_construction } }
			owner = { minerals > 750 }
		}			
		if = {
			limit = { owner = { has_policy_flag = minimum_500_for_module_auto_construction } }
			owner = { minerals > 1000 }
		}		
		if = {
			limit = { owner = { has_policy_flag = minimum_500_for_module_auto_construction } }
			owner = { minerals > 1500 }
		}		
	}	
	
	immediate = {
		if = { 
			limit = { 
				sector_controlled = yes
				owner = { has_policy_flag = sector_automation }
			}
			if = { #### economic spaceports
				limit = {
					owner = {
						OR = {
							has_policy_flag = sector_specialized_economic_module_construction
							has_policy_flag = sector_mixed_economic_emphasis_module_construction
						}
					}
				}	
				if = {
					limit = { 
						has_economic_spaceport = yes					
						owner = { has_policy_flag = sector_specialized_economic_module_construction }
					}				
					if = { 
						limit = { owner = { OR = { has_policy_flag = scrap_modules_all has_policy_flag = scrap_modules_sector } } }
						scrap_stardock_modules = yes
						scrap_defensive_modules = yes
					}	
					flag_modules = yes
					check_module_flags = yes					
					construct_module = yes					
				}	
				if = {
					limit = { 
						has_economic_spaceport = yes					
						owner = { has_policy_flag = sector_mixed_economic_emphasis_module_construction }
					}				
					if = { 
						limit = { owner = { OR = { has_policy_flag = scrap_modules_all has_policy_flag = scrap_modules_sector } } }					
						scrap_stardock_modules = yes					
					}	
					flag_modules = yes
					check_module_flags = yes					
					construct_module = yes							
				}
				if = {
					limit = { 
						has_economic_spaceport = no					
						owner = { has_policy_flag = sector_specialized_economic_module_construction }
					}
					clear_base_weapon_flags = yes
					check_base_weapon = yes
					if = { 
						limit = { owner = { OR = { has_policy_flag = scrap_modules_all has_policy_flag = scrap_modules_sector } } }					
						scrap_stardock_modules = yes
						scrap_defensive_modules = yes
					}	
					set_planet_flag = rebuild_process
					spaceport = { dismantle = yes }
					rebuild_spaceport_economic = yes					
					rebuild_economic_modules = yes					
					if = { 
						limit = { owner = { has_policy_flag = only_build_new } }
						rebuild_defensive_modules = yes
						rebuild_stardock_modules = yes
					}	
					rebuild_cleanup = yes
					remove_construction_active = yes					
					construct_module = yes						
				}	
				if = {
					limit = { 
						has_economic_spaceport = no					
						owner = { has_policy_flag = sector_mixed_economic_emphasis_module_construction }
					}
					clear_base_weapon_flags = yes
					check_base_weapon = yes
					scrap_stardock_modules = yes	
					set_planet_flag = rebuild_process					
					spaceport = { dismantle = yes }
					rebuild_spaceport_economic = yes
					rebuild_economic_modules = yes
					rebuild_defensive_modules = yes
					if = { 
						limit = { owner = { has_policy_flag = only_build_new } }						
						rebuild_stardock_modules = yes
					}					
					rebuild_cleanup = yes					
					remove_construction_active = yes
					construct_module = yes			
				}					
			}
			if = { #### defensive spaceports
				limit = {
					owner = {
						OR = {
							has_policy_flag = sector_specialized_defensive_module_construction
							has_policy_flag = sector_mixed_defensive_emphasis_module_construction
						}
					}
				}	
				if = {
					limit = { 
						has_defensive_spaceport = yes					
						owner = { has_policy_flag = sector_specialized_defensive_module_construction }
					}
					if = { 
						limit = { owner = { OR = { has_policy_flag = scrap_modules_all has_policy_flag = scrap_modules_sector } } }	
						scrap_stardock_modules = yes
						scrap_economic_modules = yes
					}	
					flag_modules = yes
					check_module_flags = yes					
					construct_module = yes									
				}	
				if = {
					limit = { 
						has_defensive_spaceport = yes					
						owner = { has_policy_flag = sector_mixed_defensive_emphasis_module_construction }
					}	
					if = { 
						limit = { owner = { OR = { has_policy_flag = scrap_modules_all has_policy_flag = scrap_modules_sector } } }						
						scrap_stardock_modules = yes					
					}	
					flag_modules = yes
					check_module_flags = yes					
					construct_module = yes							
				}
				if = {
					limit = { 
						has_defensive_spaceport = no					
						owner = { has_policy_flag = sector_specialized_defensive_module_construction }
					}
					clear_base_weapon_flags = yes
					check_base_weapon = yes
					if = { 
						limit = { owner = { OR = { has_policy_flag = scrap_modules_all has_policy_flag = scrap_modules_sector } } }						
						scrap_stardock_modules = yes
						scrap_economic_modules = yes
					}	
					set_planet_flag = rebuild_process
					spaceport = { dismantle = yes }
					rebuild_spaceport_defensive = yes
					rebuild_defensive_modules = yes
					if = { 
						limit = { owner = { has_policy_flag = only_build_new } }				
						rebuild_stardock_modules = yes
						rebuild_economic_modules = yes
					}
					rebuild_cleanup = yes					
					remove_construction_active = yes
					construct_module = yes	
				}	
				if = {
					limit = { 
						has_defensive_spaceport = no					
						owner = { has_policy_flag = sector_mixed_defensive_emphasis_module_construction }
					}
					clear_base_weapon_flags = yes
					check_base_weapon = yes
					if = { 
						limit = { owner = { OR = { has_policy_flag = scrap_modules_all has_policy_flag = scrap_modules_sector } } }						
						scrap_stardock_modules = yes
					}	
					set_planet_flag = rebuild_process					
					spaceport = { dismantle = yes }
					rebuild_spaceport_defensive = yes
					rebuild_economic_modules = yes
					rebuild_defensive_modules = yes
					if = { 
						limit = { owner = { has_policy_flag = only_build_new } }		
						rebuild_stardock_modules = yes
					}	
					rebuild_cleanup = yes					
					remove_construction_active = yes
					construct_module = yes	
				}					
			}			
		}	
		if = { 
			limit = { 
				sector_controlled = no
				owner = { 
					OR = {
						has_policy_flag = core_automation
						has_policy_flag = core_edicts
					}
				}	
			}
			if = { #### economic spaceports
				limit = {
					OR = {
						owner = {
							OR = {
								has_policy_flag = core_specialized_economic_module_construction
								has_policy_flag = core_mixed_economic_emphasis_module_construction
							}
						}	
						OR = {
							has_planet_flag = spaceport_automation_economic_specialized	
							has_planet_flag = spaceport_automation_economic_mixed
						}	
					}
				}	
				if = {
					limit = { 
						has_economic_spaceport = yes					
						OR = {
							owner = { has_policy_flag = core_specialized_economic_module_construction }
							has_planet_flag = spaceport_automation_economic_specialized
						}	
					}			
					if = { 
						limit = { owner = { has_policy_flag = scrap_modules_all } }							
						scrap_stardock_modules = yes
						scrap_defensive_modules = yes
					}	
					flag_modules = yes
					check_module_flags = yes					
					construct_module = yes								
				}	
				if = {
					limit = { 
						has_economic_spaceport = yes					
						OR = {
							owner = { has_policy_flag = core_mixed_economic_emphasis_module_construction }
							has_planet_flag = spaceport_automation_economic_mixed
						}	
					}		
					if = { 
						limit = { owner = { has_policy_flag = scrap_modules_all } }												
						scrap_stardock_modules = yes					
					}	
					flag_modules = yes
					check_module_flags = yes					
					construct_module = yes										
				}
				if = {
					limit = { 
						has_economic_spaceport = no					
						OR = {
							owner = { has_policy_flag = core_specialized_economic_module_construction }
							has_planet_flag = spaceport_automation_economic_specialized
						}	
					}
					clear_base_weapon_flags = yes
					check_base_weapon = yes
					if = { 
						limit = { owner = { has_policy_flag = scrap_modules_all } }												
						scrap_stardock_modules = yes
						scrap_defensive_modules = yes
					}	
					set_planet_flag = rebuild_process
					spaceport = { dismantle = yes }
					rebuild_spaceport_economic = yes
					rebuild_economic_modules = yes
					if = { 
						limit = { owner = { has_policy_flag = only_build_new } }							
						rebuild_stardock_modules = yes
					}	
					rebuild_cleanup = yes			
					remove_construction_active = yes					
					construct_module = yes	
				}	
				if = {
					limit = { 
						has_economic_spaceport = no					
						OR = {
							owner = { has_policy_flag = core_mixed_economic_emphasis_module_construction }
							has_planet_flag = spaceport_automation_economic_mixed
						}	
					}
					clear_base_weapon_flags = yes
					check_base_weapon = yes
					if = { 
						limit = { owner = { has_policy_flag = scrap_modules_all } }						
						scrap_stardock_modules = yes	
					}	
					set_planet_flag = rebuild_process
					spaceport = { dismantle = yes }
					rebuild_spaceport_economic = yes
					rebuild_economic_modules = yes
					rebuild_defensive_modules = yes
					if = { 
						limit = { owner = { has_policy_flag = only_build_new } }							
						rebuild_stardock_modules = yes
					}						
					rebuild_cleanup = yes					
					remove_construction_active = yes
					construct_module = yes	
				}					
			}
			if = { #### defensive spaceports
				limit = {
					OR = {
						owner = {
							OR = {
								has_policy_flag = core_specialized_defensive_module_construction
								has_policy_flag = core_mixed_defensive_emphasis_module_construction
							}
						}	
						OR = {
							has_planet_flag = spaceport_automation_defensive_specialized	
							has_planet_flag = spaceport_automation_defensive_mixed
						}	
					}
				}	
				if = {
					limit = { 
						has_defensive_spaceport = yes					
						OR = {
							owner = { has_policy_flag = core_specialized_defensive_module_construction }
							has_planet_flag = spaceport_automation_defensive_specialized
						}	
					}		
					if = { 
						limit = { owner = { has_policy_flag = scrap_modules_all } }						
						scrap_stardock_modules = yes
						scrap_economic_modules = yes
					}	
					flag_modules = yes
					check_module_flags = yes					
					construct_module = yes								
				}	
				if = {
					limit = { 
						has_defensive_spaceport = yes					
						OR = {
							owner = { has_policy_flag = core_mixed_defensive_emphasis_module_construction }
							has_planet_flag = spaceport_automation_defensive_mixed
						}	
					}			
					if = { 
						limit = { owner = { has_policy_flag = scrap_modules_all } }						
						scrap_stardock_modules = yes					
					}	
					flag_modules = yes
					check_module_flags = yes					
					construct_module = yes								
				}
				if = {
					limit = { 
						has_defensive_spaceport = no					
						OR = {
							owner = { has_policy_flag = core_specialized_defensive_module_construction }
							has_planet_flag = spaceport_automation_defensive_specialized
						}	
					}
					clear_base_weapon_flags = yes
					check_base_weapon = yes
					if = { 
						limit = { owner = { has_policy_flag = scrap_modules_all } }						
						scrap_stardock_modules = yes
						scrap_economic_modules = yes
					}	
					set_planet_flag = rebuild_process
					spaceport = { dismantle = yes }
					rebuild_spaceport_defensive = yes
					rebuild_defensive_modules = yes	
					if = { 
						limit = { owner = { has_policy_flag = only_build_new } }	
						rebuild_stardock_modules = yes
					}	
					rebuild_cleanup = yes					
					remove_construction_active = yes
					construct_module = yes	
				}	
				if = {
					limit = { 
						has_defensive_spaceport = no					
						OR = {
							owner = { has_policy_flag = core_mixed_defensive_emphasis_module_construction }
							has_planet_flag = spaceport_automation_defensive_mixed
						}	
					}
					clear_base_weapon_flags = yes
					check_base_weapon = yes
					if = { 
						limit = { owner = { has_policy_flag = scrap_modules_all } }								
						scrap_stardock_modules = yes
					}	
					set_planet_flag = rebuild_process
					spaceport = { dismantle = yes }
					rebuild_spaceport_defensive = yes
					rebuild_economic_modules = yes
					rebuild_defensive_modules = yes	
					if = { 
						limit = { owner = { has_policy_flag = only_build_new } }	
						rebuild_stardock_modules = yes
					}						
					rebuild_cleanup = yes					
					remove_construction_active = yes
					construct_module = yes	
				}					
			}								
			if = { #### stardock spaceports
				limit = {
					OR = {
						owner = {
							has_policy_flag = core_specialized_stardock_module_construction
						}	
						has_planet_flag = spaceport_automation_stardock_specialized	
					}
				}	
				if = {
					limit = { 
						has_stardock_spaceport = yes					
					}	
					if = { 
						limit = { owner = { has_policy_flag = scrap_modules_all } }						
						scrap_defensive_modules = yes
						scrap_economic_modules = yes
					}	
					flag_modules = yes
					check_module_flags = yes					
					construct_module = yes									
				}	
				if = {
					limit = { 
						has_stardock_spaceport = no					
					}
					clear_base_weapon_flags = yes
					check_base_weapon = yes
					if = { 
						limit = { owner = { has_policy_flag = scrap_modules_all } }						
						scrap_defensive_modules = yes
						scrap_economic_modules = yes
					}	
					set_planet_flag = rebuild_process
					spaceport = { dismantle = yes }	
					rebuild_spaceport_stardock = yes
					rebuild_stardock_modules = yes					
					if = { 
						limit = { owner = { has_policy_flag = only_build_new } }					
						rebuild_defensive_modules = yes
						rebuild_economic_modules = yes
					}						
					rebuild_cleanup = yes					
					remove_construction_active = yes
					construct_module = yes						
				}	
			}					
		}				
	}
}

planet_event = { #this event builds spaceport modules if some form of automation is active on the planet.
	id = ex_spaceport_events.101
	hide_window = yes
	is_triggered_only = yes
	
	immediate = { 
		if = {
			limit = {
				AND = {
					exists = owner
					owner = { 
						OR = {
							AND = {
								has_policy_flag = minimum_250_for_module_auto_construction
								minerals > 500				
							}
							AND = {
								has_policy_flag = minimum_500_for_module_auto_construction
								minerals > 1000
							}	
							AND = {
								has_policy_flag = minimum_750_for_module_auto_construction
								minerals > 1500
							}	
							AND = {
								has_policy_flag = minimum_1000_for_module_auto_construction
								minerals > 2000
							}	
						}
					}								
					OR = {
						AND = {
							sector_controlled = yes
							OR = {
								AND = {
									owner = { has_policy_flag = sector_specialized_economic_module_construction }
									can_build_economic_module = yes
								}								
								AND = {
									owner = { has_policy_flag = sector_specialized_defensive_module_construction }
									can_build_defensive_module = yes
								}																
								AND = {
									owner = { 
										OR = {
											has_policy_flag = sector_mixed_economic_emphasis_module_construction
											has_policy_flag = sector_mixed_defensive_emphasis_module_construction
										}
									}	
									can_build_economic_module = yes
									can_build_defensive_module = yes
								}
							}	
						}
						AND = {
							sector_controlled = no
							OR = {
								AND = {
									OR = {
										owner = { has_policy_flag = core_specialized_stardock_module_construction }
										has_planet_flag = spaceport_automation_stardock_specialized
									}	
									can_build_stardock_module = yes
								}							
								AND = {
									OR = {
										owner = { has_policy_flag = core_specialized_economic_module_construction }
										has_planet_flag = spaceport_automation_economic_specialized
									}	
									can_build_economic_module = yes
								}								
								AND = {
										OR = {
										owner = { has_policy_flag = core_specialized_defensive_module_construction }
										has_planet_flag = spaceport_automation_defensive_specialized
									}	
									can_build_defensive_module = yes
								}																
								AND = {
									OR = {
										owner = { 
											OR = {
												has_policy_flag = core_mixed_economic_emphasis_module_construction
												has_policy_flag = core_mixed_defensive_emphasis_module_construction												
											}
										}	
										has_planet_flag = spaceport_automation_economic_mixed
										has_planet_flag = spaceport_automation_defensive_mixed
									}	
									can_build_economic_module = yes
									can_build_defensive_module = yes
								}
							}	
						}						
					}	
				}					
			}				
			if = {
				limit = { sector_controlled = yes }
				if = { 
					limit = { owner = { has_policy_flag = sector_specialized_economic_module_construction } }
					roll_economic_module = yes
					remove_construction_active = yes
					break = yes
				}	
				if = { 
					limit = { owner = { has_policy_flag = sector_mixed_economic_emphasis_module_construction } }
					random_list = {
						75 = { roll_economic_module = yes }
						25 = { roll_defensive_module = yes }
					}	
					remove_construction_active = yes
					break = yes
				}	
				if = { 
					limit = { owner = { has_policy_flag = sector_specialized_defensive_module_construction } }
					roll_defensive_module = yes
					remove_construction_active = yes
					break = yes
				}
				if = { 
					limit = { owner = { has_policy_flag = sector_mixed_defensive_emphasis_module_construction } }
					random_list = {
						25 = { roll_economic_module = yes }
						75 = { roll_defensive_module = yes }
					}	
					remove_construction_active = yes
					break = yes
				}			
			}
			if = {
				limit = { sector_controlled = no }
				if = { 
					limit = { 
						OR = {
							owner = { has_policy_flag = core_specialized_economic_module_construction }
							has_planet_flag = spaceport_automation_economic_specialized
						}	
					}
					roll_economic_module = yes
					remove_construction_active = yes
					break = yes
				}	
				if = { 
					limit = { 
						OR = {
							owner = { has_policy_flag = core_mixed_economic_emphasis_module_construction }
							has_planet_flag = spaceport_automation_economic_mixed
						}	
					}
					random_list = {
						75 = { roll_economic_module = yes }
						25 = { roll_defensive_module = yes }
					}	
					remove_construction_active = yes
					break = yes
				}	
				if = { 
					limit = { 
						OR = {
							owner = { has_policy_flag = core_specialized_defensive_module_construction }
							has_planet_flag = spaceport_automation_defensive_specialized
						}	
					}
					roll_defensive_module = yes
					remove_construction_active = yes
					break = yes
				}
				if = { 
					limit = { 
						OR = {
							owner = { has_policy_flag = core_mixed_defensive_emphasis_module_construction }
							has_planet_flag = spaceport_automation_defensive_mixed
						}	
					}
					random_list = {
						25 = { roll_economic_module = yes }
						75 = { roll_defensive_module = yes }
					}	
					remove_construction_active = yes
					break = yes
				}
				if = { 
					limit = { 
						OR = {
							owner = { has_policy_flag = core_specialized_stardock_module_construction }
							has_planet_flag = spaceport_automation_stardock_specialized
						}	
					}
					roll_stardock_module = yes
					remove_construction_active = yes
					break = yes
				}				
			}
			else = { planet_event = { id = ex_spaceport_events.101 days = 30 } } ## this in combination with the main limit field is a failsafe meant to assure modules will be constructed no matter what. 
		}	
	}		
}

#cleanup events 

country_event = { #fired using the on_policy_change on action trigger. This event removes redundant planetary flags from edicts.
	id = ex_spaceport_events.110
	hide_window = yes
	is_triggered_only = yes
	
	trigger = {
		last_changed_policy = spaceport_automation
		NOT = { has_policy_flag = core_edicts }
	}	
	
	immediate = {
		every_owned_planet = {
			limit = {
				OR = {
					has_planet_flag = spaceport_automation_economic_specialized	
					has_planet_flag = spaceport_automation_economic_mixed
					has_planet_flag = spaceport_automation_stardock_specialized
					has_planet_flag = spaceport_automation_defensive_specialized
					has_planet_flag = spaceport_automation_defensive_mixed
					has_planet_flag = spaceport_automation_disable_local
				}		
			}
			remove_planet_flag = spaceport_automation_economic_specialized	
			remove_planet_flag = spaceport_automation_economic_mixed
			remove_planet_flag = spaceport_automation_stardock_specialized
			remove_planet_flag = spaceport_automation_defensive_specialized
			remove_planet_flag = spaceport_automation_defensive_mixed	
			remove_planet_flag = spaceport_automation_disable_local			
		}
	}
}	

country_event = { #fired using the on_policy_change on action trigger. This event removes the "unavailable" and "under construction" placeholder modules from any spaceport that has automation disabled. 
	id = ex_spaceport_events.111
	hide_window = yes
	is_triggered_only = yes
	
	trigger = {
		last_changed_policy = spaceport_automation
		has_policy_flag = spaceport_automation_disabled
	}	
	
	immediate = {
		every_owned_planet = {
			limit = {
				has_spaceport = yes	
				OR = {
					has_spaceport_module = slot_unavailable_9
					has_spaceport_module = slot_unavailable_8
					has_spaceport_module = slot_unavailable_7
					has_spaceport_module = slot_unavailable_6
					has_spaceport_module = slot_unavailable_5
					has_spaceport_module = slot_unavailable_4
					has_spaceport_module = slot_unavailable_3
					has_spaceport_module = slot_unavailable_2
					has_spaceport_module = slot_unavailable_1
					has_spaceport_module = module_under_construction
				}						
			}
			if = { limit = { has_spaceport_module = slot_unavailable_9 } remove_spaceport_module = slot_unavailable_9 }
			if = { limit = { has_spaceport_module = slot_unavailable_8 } remove_spaceport_module = slot_unavailable_8 } 
			if = { limit = { has_spaceport_module = slot_unavailable_7 } remove_spaceport_module = slot_unavailable_7 }
			if = { limit = { has_spaceport_module = slot_unavailable_6 } remove_spaceport_module = slot_unavailable_6 }
			if = { limit = { has_spaceport_module = slot_unavailable_5 } remove_spaceport_module = slot_unavailable_5 }
			if = { limit = { has_spaceport_module = slot_unavailable_4 } remove_spaceport_module = slot_unavailable_4 }
			if = { limit = { has_spaceport_module = slot_unavailable_3 } remove_spaceport_module = slot_unavailable_3 }
			if = { limit = { has_spaceport_module = slot_unavailable_2 } remove_spaceport_module = slot_unavailable_2 }
			if = { limit = { has_spaceport_module = slot_unavailable_1 } remove_spaceport_module = slot_unavailable_1 }
			if = { limit = { has_spaceport_module = module_under_construction } remove_spaceport_module = module_under_construction }
		}
	}
}

planet_event = { #fired on a daily tick, removing the "unavailable" and "under construction" placeholder modules from any spaceport that has automation disabled local planet flag. 
	id = ex_spaceport_events.112
	hide_window = yes	
	
	trigger = {
		has_planet_flag = spaceport_automation_disable_local
		has_spaceport = yes
		OR = {
			has_spaceport_module = slot_unavailable_9
			has_spaceport_module = slot_unavailable_8
			has_spaceport_module = slot_unavailable_7
			has_spaceport_module = slot_unavailable_6
			has_spaceport_module = slot_unavailable_5
			has_spaceport_module = slot_unavailable_4
			has_spaceport_module = slot_unavailable_3
			has_spaceport_module = slot_unavailable_2
			has_spaceport_module = slot_unavailable_1
			has_spaceport_module = module_under_construction
		}				
	}	
	
	immediate = {
		if = { limit = { has_spaceport_module = slot_unavailable_9 } remove_spaceport_module = slot_unavailable_9 }
		if = { limit = { has_spaceport_module = slot_unavailable_8 } remove_spaceport_module = slot_unavailable_8 } 
		if = { limit = { has_spaceport_module = slot_unavailable_7 } remove_spaceport_module = slot_unavailable_7 }
		if = { limit = { has_spaceport_module = slot_unavailable_6 } remove_spaceport_module = slot_unavailable_6 }
		if = { limit = { has_spaceport_module = slot_unavailable_5 } remove_spaceport_module = slot_unavailable_5 }
		if = { limit = { has_spaceport_module = slot_unavailable_4 } remove_spaceport_module = slot_unavailable_4 }
		if = { limit = { has_spaceport_module = slot_unavailable_3 } remove_spaceport_module = slot_unavailable_3 }
		if = { limit = { has_spaceport_module = slot_unavailable_2 } remove_spaceport_module = slot_unavailable_2 }
		if = { limit = { has_spaceport_module = slot_unavailable_1 } remove_spaceport_module = slot_unavailable_1 }
		if = { limit = { has_spaceport_module = module_under_construction } remove_spaceport_module = module_under_construction }
	}
}		
	