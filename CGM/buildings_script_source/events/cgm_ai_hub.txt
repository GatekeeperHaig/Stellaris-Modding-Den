namespace = cgm_ai_hub

@spending_threshold = 149 
### we should move the spending threshold into a per country variable, so the amount is dynamically calculated given some factors rather than a static sum. 
### I also did not create different settings for the building construction reserve subtraction. We should decide how to implement this with policies for players. 
### Currently it subtracts a flat 20% of the minerals income variable value from the minerals reserve pool.  

event = {
	id = cgm_ai_hub.1
	is_triggered_only = yes
	hide_window = yes
	trigger = { 				
		OR = { 
			full_ai_routines = yes
			mixed_ai_routines = yes
		}
	}
	
	immediate = { 
		every_country = { 
			limit = { 
				OR = { 
					is_country_type = default
					is_country_type = awakened_fallen_empire
				}
			}
			check_income = yes
			check_resource_requirements = yes
			if = { 
				limit = { NOT = { has_country_flag = starbase_and_planet_check_delay } }
				country_event = { id = cgm_starbase.1 }
				every_owned_planet = { check_and_set_building_flags = yes }
				set_timed_country_flag = { flag = starbase_and_planet_check_delay days = 360 }
			}	
			if = { 
				limit = { 
					check_variable = { which = minerals_reserve value > 0 } 
					check_variable = { which = minerals_income value > 0 } 
				}
				set_variable = { which = reserve_transport value = minerals_income }
				multiply_variable = { which = reserve_transport value = 0.2 } 
				if = { 
					limit = { check_variable = { which = minerals_reserve value > reserve_transport } }
					if = { 
						limit = { check_variable = { which = building_construction_reserve value > 0 } }
						change_variable = { which = building_construction_reserve value = reserve_transport }						
						else = { set_variable = { which = building_construction_reserve value = reserve_transport } }					
					}	
					while = { 
						limit = { check_variable = { which = reserve_transport value > 9999 } }
						add_minerals = -10000
						change_variable = { which = reserve_transport value = -10000 }
					}	
					while = { 
						limit = { check_variable = { which = reserve_transport value > 999 } }
						add_minerals = -1000
						change_variable = { which = reserve_transport value = -1000 }
					}						
					while = { 
						limit = { check_variable = { which = reserve_transport value > 99 } }
						add_minerals = -100
						change_variable = { which = reserve_transport value = -100 }
					}						
					while = { 
						limit = { check_variable = { which = reserve_transport value > 9 } }
						add_minerals = -10
						change_variable = { which = reserve_transport value = -10 }
					}						
					while = { 
						limit = { check_variable = { which = reserve_transport value > 0 } }
						add_minerals = -1
						change_variable = { which = reserve_transport value = -1 }
					}													
					if = { 
						limit = { check_variable = { which = building_construction_reserve value > @spending_threshold } }
						country_event = { id = cgm_auto.0 }							
					}				
				}	
			}	
		}
	}
}	