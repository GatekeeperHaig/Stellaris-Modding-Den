check_and_set_building_construction = {		
	if = { 
		#fortify planet if it has the flag - this is top priority to defend from invasion
		limit = { 
			is_habitat = no
			minerals > 299
			OR = { 
				has_planet_flag = fortify_planet
				has_planet_flag = build_planetary_shield_generator				
			}			
		}	
		set_fortification_building = yes
		else = {			
			if = {
				limit = { 
					#otherwise if owner has one of these flags - build resource building given an appropriate tile exists
					OR = { 
						AND = { 
							owner = { has_country_flag = minerals_focus_factor_2 }
							any_tile = { has_building = no has_blocker = no OR = { has_deposit = mineral_building_tile has_deposit = no } } 
						}	
						AND = { 
							owner = { has_country_flag = energy_focus_factor_2 }
							any_tile = { has_building = no has_blocker = no OR = { has_deposit = mineral_building_tile has_deposit = no } }
						}	
						AND = { 
							owner = { 
								OR = { 
									has_country_flag = food_focus_factor_3
									has_country_flag = food_focus_factor_4
								}	
							}	
							any_tile = { has_building = no has_blocker = no OR = { has_deposit = mineral_building_tile has_deposit = no } }
						}								
						AND = { 
							owner = { has_country_flag = society_research_focus_factor_2 }
							any_tile = { has_building = no has_blocker = no OR = { has_deposit = mineral_building_tile has_deposit = no } }
						}	
						AND = { 
							owner = { has_country_flag = physics_research_focus_factor_2 }
							any_tile = { has_building = no has_blocker = no OR = { has_deposit = mineral_building_tile has_deposit = no } }
						}	
						AND = { 
							owner = { has_country_flag = engineering_research_focus_factor_2 }
							any_tile = { has_building = no has_blocker = no OR = { has_deposit = mineral_building_tile has_deposit = no } }
						}	
					}	
					set_resource_building_priority_2 = yes
				}				
				#otherwise prioritize pop growth buildings if none exist 
				else = { 	
					if = { 
						limit = { 
							has_planet_flag = build_pop_growth_building
							NOR = { 
								has_building = building_clinic 
								has_building = building_hospital 
								has_building = building_spare_parts_depot 
								has_building = building_unit_assembly_plant		
							}	
						}	
						set_pop_growth_building = yes	
						else = { 
							#otherwise prioritize unity buildings - if none exist
							if = { 
								limit = { 
									OR = { 
										AND = { 
											owner = { is_machine_empire = no is_spiritualist = no }
											has_standard_unity_building = no
										}	
										AND = { 
											owner = { is_spiritualist = yes }
											has_spiritualist_unity_building = no
										}								
										AND = { 
											owner = { is_machine_empire = yes }
											has_machine_unity_building = no
										}													
									}
								}
								set_unity_building = yes
								#otherwise civic and tradition planet unique buildings
								else = { 
									if = { 
										limit = { 
											OR = { 
												AND = {
													owner = { has_utopian_dream = yes }
													NOT = { has_building = building_paradise_dome }
												}	
												AND = {
													owner = { has_diplomacy_alien_tourism = yes }
													NOT = { has_building = building_visitor_center }
												}	
												AND = {
													owner = { has_synchronicity_hive_mind_synapse = yes }
													NOT = { has_building = building_hive_synapse }
												}														
												AND = {
													owner = { has_purity_symbol_purity = yes }
													NOT = { has_building = building_symbol_purity }
												}	
												AND = {
													owner = { has_synchronicity_machine_center = yes }
													NOT = { has_building = building_control_center }
												}	
												AND = {
													has_planet_flag = build_neuro_electric_amplifier
													NOT = { has_building = building_neuro_electric_amplifier }
												}															
											}
										}	
										set_civic_and_tradition_building = yes	
										#otherwise prioritize slave processing if applicable
										else = { 
											if = { 
												limit = { has_planet_flag = build_slave_processing }
												set_slave_processing = yes	
												#otherwise if owner has one of these flags - build resource building given an appropriate tile exists 
												else = { 
													if = { 
														limit = { 														
															OR = { 
																AND = { 
																	owner = { has_country_flag = minerals_focus_factor_1 }
																	any_tile = { has_building = no has_blocker = no OR = { has_deposit = mineral_building_tile has_deposit = no } } 
																}	
																AND = { 
																	owner = { has_country_flag = energy_focus_factor_1 }
																	any_tile = { has_building = no has_blocker = no OR = { has_deposit = mineral_building_tile has_deposit = no } }
																}	
																AND = { 
																	owner = { 
																		OR = { 
																			has_country_flag = food_focus_factor_1
																			has_country_flag = food_focus_factor_2
																		}	
																	}	
																	any_tile = { has_building = no has_blocker = no OR = { has_deposit = mineral_building_tile has_deposit = no } }
																}								
																AND = { 
																	owner = { has_country_flag = society_research_focus_factor_1 }
																	any_tile = { has_building = no has_blocker = no OR = { has_deposit = mineral_building_tile has_deposit = no } }
																}	
																AND = { 
																	owner = { has_country_flag = physics_research_focus_factor_1 }
																	any_tile = { has_building = no has_blocker = no OR = { has_deposit = mineral_building_tile has_deposit = no } }
																}	
																AND = { 
																	owner = { has_country_flag = engineering_research_focus_factor_1 }
																	any_tile = { has_building = no has_blocker = no OR = { has_deposit = mineral_building_tile has_deposit = no } }
																}	
															}	
														}
														set_resource_building_priority_1 = yes
														#otherwise do the less important planet unique buildings
														else = { 
															if = { 
																limit = { 
																	OR = { 
																		has_planet_flag = build_military_academy
																		has_planet_flag = build_clone_vats
																		has_planet_flag = build_war_factory
																	}
																}	
																set_military_buildup_building = yes
																#otherwise build resource building if possible
																else = { set_resource_building_priority_0 = yes }																		
															}
														}	
													}
												}
											}
										}
									}	
								}
							}
						}																		
					}						
				}							
			}								
		}
	}
	set_timed_planet_flag = { flag = new_construction_automation_checked days = 1 }
}		

set_fortification_building = {
	if = { 
		limit = { 
			has_planet_flag = build_planetary_shield_generator
			minerals > 349 
			has_capital_1 = yes
			owner = { has_technology = "tech_planetary_shield_generator" }
		} 
		random_tile = { 
			limit = { 
				has_building = no
				has_blocker = no
				OR = { 
					AND = { 
						overhauled_building_stats_enabled = no
						OR = { 
							has_deposit = engineering_research_building_tile
							has_deposit = physics_research_building_tile
							has_deposit = no
						}
					}	
					AND = { 
						overhauled_building_stats_enabled = yes
						OR = { 
							has_deposit = unity_building_tile
							has_deposit = no
						}
					}					
				}	
			}
			add_building_construction = building_planetary_shield_generator	
		}
		else = { 
			random_tile = { 
				limit = { 
					has_building = no
					has_blocker = no
					OR = { 
						has_deposit = unity_building_tile
						has_deposit = no							
						AND = {
							has_resource = { type = food amount > 0 } 			
							has_any_tile_strategic_resource = no
							NOR = { 
								has_resource = { type = minerals amount > 0 } 			
								has_resource = { type = energy amount > 0 } 			
								has_resource = { type = society_research amount > 0 } 			
								has_resource = { type = physics_research amount > 0 } 			
								has_resource = { type = engineering_research amount > 0 } 			
								has_resource = { type = unity amount > 0 } 			
							}							
							prev.owner = { 
								OR = { 
									AND = { 
										is_machine_empire = yes
										is_servitor = no
									}
									NOR = { 
										has_country_flag = food_focus_factor_1
										has_country_flag = food_focus_factor_2
										has_country_flag = food_focus_factor_3
										has_country_flag = food_focus_factor_4
									}		
								}
							}						
						}	
					}	
				}
				add_building_construction = building_stronghold	
			}		
		}
	}
}	
		