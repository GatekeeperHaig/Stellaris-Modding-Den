namespace = ex_ai_building_events

event = { #this event sets variables into scopes. It fires on a monthly pulse and on game start. 
	id = ex_ai_building_events.0
	hide_window = yes
	is_triggered_only = yes
		
	immediate = {
		every_country = {
			limit = { 
				OR = {
					is_country_type = default
					is_country_type = fallen_empire
					is_country_type = awakened_fallen_empire
				}	
			}
			country_event = { id = ex_ai_building_events.1 }	
		}
	}
}	

country_event = { #this event sets variables into scopes. 
	id = ex_ai_building_events.1
	hide_window = yes
	is_triggered_only = yes
	
	immediate = {
		if = { 
			limit = { NOT = { has_country_flag = ex_country_check_delay } }				
			set_variable = { which = energy_weight value = 0 }
			set_variable = { which = minerals_weight value = 0 }
			set_variable = { which = food_weight value = 0 }	
			check_deficities = yes
			check_income_level = yes
			set_time_country_flag = { flag = ex_country_check_delay days = 180 }
		}	
		every_owned_planet = {
			limit = { 
				NOT = { has_planet_flag = ex_planet_check_delay }
				OR = {
					prev = { is_ai = yes }
					sector_controlled = yes
				}	
			}
			set_variable = { which = planet_energy_mult value = 1 }
			set_variable = { which = planet_minerals_mult value = 1 }
			set_variable = { which = planet_food_mult value = 1 }
			set_variable = { which = planet_unity_mult value = 1 }
			set_variable = { which = planet_society_mult value = 1 }
			set_variable = { which = planet_physics_mult value = 1 }
			set_variable = { which = planet_engineering_mult value = 1 }				
			calculate_planet_weights = yes
			every_tile = {
				limit = { has_blocker = no }
				set_tile_building_weight = yes
			}	
			set_time_planet_flag = { flag = ex_planet_check_delay days = 360 } 
		}				
	}
}	
	

event = { #this event runs on a monthly scope. 
	id = ex_ai_building_events.1
	hide_window = yes
	is_triggered_only = yes

	immediate = { 
		every_country = {

			every_owned_planet = {
				limit = { 
					is_colony = yes
					OR = {
						owner = { is_ai = yes }
						sector_controlled = yes
					}	
				}
								
				every_owned_pop = {
					limit = { OR = { is_robot_pop = yes is_sapient = yes } }
					calculate_pop_multipliers = yes
				}				
				every_tile = {
					limit = { 
						is_orbital_tile = no
						has_blocker = no
					}
					if = {
						limit = { 
							any_neighboring_tile = { 
								OR = {
									AND = {
										has_building = yes
										OR = { 	
											has_capital_building = yes
											has_hyperstorage_building = yes 
											has_polytechnic_building = yes
											has_special_capital_resource_building = yes
											AND = {
												has_global_flag = ex_planets_enhanced_active
												has_sr_adj_bonus_building = yes
											}	
										}	
									}
									AND = {
										has_blocker = yes
										has_adj_bonus_blocker = yes
									}		
								}							
							}							
						}
						calculate_adjcancy_weights = yes
					}
					calculate_tile_weights = yes
				}					
			}		
		}	
	}	
}

#this event runs on a monthly scope.
#it places planet flags that are used by specific planet unique buildings

event = {  
	id = ex_ai_building_events.2
	hide_window = yes
	is_triggered_only = yes
	
	immediate = {
		every_country = {
			limit = { is_country_type = default	}	
			every_owned_planet = {
				if = { #military buildings
					limit = { 
						years_passed > 25
						NOR = { 
							has_planet_flag = fortify_planet
							AND = {
								prev = { is_at_war = no }
								count_tile = {
									limit = {
										OR = {
											has_building = building_stronghold
											has_building = building_fortress
										}
									}
									count > 2
								}	
							}	
						}
						OR = {
							unrest > 50
							any_country = {
								is_at_war_with = prevprev
								any_owned_planet = {
									is_colony = yes
									#distance = { source = prevprev min = 70 max = 100 }
								}
							}	
									
							AND = {
								OR = {
									has_capital_1 = yes
									has_capital_2 = yes
								}	
								NOR = {
									has_building = building_stronghold
									has_building = building_fortress	
								}
							}	
							AND = {
								has_capital_3 = yes
								count_tile = {
									limit = {
										OR = {
											has_building = building_stronghold
											has_building = building_fortress
										}
									}
									count < 2
								}	
							}								
						}
					}
					set_timed_planet_flag = { flag = fortify_planet days = 30 }
				}
				if = { #pop growth buildings
					limit = { 
						prev = {
							OR = { 
								has_technology = "tech_frontier_health"
								has_technology = "tech_frontier_hospital"
							}
						}
						NOR = { 
							has_building = building_clinic
							has_building = building_building_hospital							
							has_building = building_spare_parts_depot
							has_building = building_unit_assembly_plant							
						}	
						free_pop_tiles > 2
						OR = {
							any_owned_pop = {
								is_robot_pop = no								
								has_population_control = no
							}								
							AND = {
								prev = { 
									OR = {
										has_authority = auth_machine_intellgience
										has_country_flag = synthethic_age
									}
									balance > 250
								}	
								any_owned_pop = { is_robot_pop = yes }
							}
						}
					}
					set_timed_planet_flag = { flag = build_pop_growth_building days = 30 }
				}
				if = {
					limit = {
						prev = { 
							has_technology = "tech_neural_implants"
							OR = {
								AND = {
									overhauled_building_content_enabled = no
									is_machine_empire = no
								}	
								AND = {
									overhauled_building_content_enabled = yes
									is_gestalt_consciousness = no
								}	
							}
							has_policy_flag = slavery_allowed
						}
						any_owned_pop = { is_enslaved = yes }
						OR = {
							count_pops = {
								limit = { 
									OR = {
										has_slavery_type = { country = owner type = slavery_military }
										has_slavery_type = { country = owner type = slavery_normal }
									}	
								}
								count > 2
							}	
							unrest > 30
						}	
					}	
					set_timed_planet_flag = { flag = build_slave_processing days = 30 }
				}								
			}					
		}
	}
}	