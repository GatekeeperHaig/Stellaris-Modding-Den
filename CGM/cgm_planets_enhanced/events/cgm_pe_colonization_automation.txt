namespace = cgm_pe_colonization_automation

event = { #on_monthly_pulse
	id = cgm_pe_colonization_automation.1
	hide_window = yes
	is_triggered_only = yes
	
	trigger = { has_global_flag = cgm_colonization_automation_enabled }
	
	immediate = { 
		every_country = { 
			limit = { 
				OR = { 
					is_ai = yes
					has_country_flag = cgm_colonization_automation_country_enabled				
				}				
				OR = { 
					is_country_type = default
					is_country_type = awakened_fallen_empire
				}			
				any_owned_ship = { 
					is_ship_class = shipclass_colonizer 
					NOT = { has_ship_flag = assigned_colonizer }
				}
				any_planet_within_border = { 
					NOR = { 
						exists = owner
						has_planet_flag = colonizer_assigned
						has_modifier = holy_planet
					}					
					is_colonizable = yes 
					is_colony = no 		
					is_under_colonization = no
					can_colonize = { who = prev status = yes }	
				}
			}		
			country_event = { id = cgm_pe_colonization_automation.2 days = 1 random = 20 } 
		}
	}
}
country_event = { 
	id = cgm_pe_colonization_automation.2
	hide_window = yes
	is_triggered_only = yes	
	
	immediate = { 	
		set_variable = { which = available_colony_targets value = 0 }
		every_planet_within_border = { 
			limit = { 
				NOR = { 
					exists = owner					
					has_planet_flag = colonizer_assigned
					has_modifier = holy_planet
				}					
				is_colonizable = yes 
				is_colony = no 		
				is_under_colonization = no
				can_colonize = { who = root status = yes }	
				habitability = { who = root.species value > 0.19 } 
			}
			prev = { change_variable = { which = available_colony_targets value = 1 } }
			set_planet_flag = cgm_colonization_target
			if = { 
				limit = { NOT = { has_planet_flag = cgm_colonization_processed } }
				set_colonization_value = yes				
				set_timed_planet_flag = { flag = cgm_colonization_processed days = 3600 }				
			}	
		}
		set_variable = { which = available_colony_ships value = 0 }
		every_owned_ship = { 
			limit = { is_ship_class = shipclass_colonizer NOT = { has_ship_flag = assigned_colonizer } }
			prev = { change_variable = { which = available_colony_ships value = 1 } }
		}	
		while = { 
			limit = { 
				check_variable = { which = available_colony_ships value > 0 }
				check_variable = { which = available_colony_targets value > 0 }
			}	
			random_owned_ship = { 
				limit = { 
					is_ship_class = shipclass_colonizer
					NOT = { has_ship_flag = assigned_colonizer } 
				}					
				species = { save_event_target_as = cgm_colonizing_species }
				save_event_target_as = cgm_colonizer
				assign_colonizer = yes			
			}
		}
	}
}	

fleet_event = { 
	id = cgm_pe_colonization_automation.4
	hide_window = yes
	is_triggered_only = yes	
	
	immediate = { 
		auto_move_to_planet = {
			target = event_target:cgm_colonization_target
			clear_auto_move_on_arrival = yes
		}
		orbit = { 
			start_colony = {
				owner = root.owner
				species = event_target:cgm_colonizing_species
			}
		}	
		delete_fleet = this
	}						
}	